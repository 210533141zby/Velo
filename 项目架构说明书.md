# 项目架构说明书

## 1. 项目简介
本项目是一个**智能 Wiki 知识库系统**，旨在提供文档管理、知识沉淀以及基于 AI 的智能问答功能。系统深度集成了 RAG (检索增强生成) 技术，允许用户与私有文档库进行对话，辅助知识检索与创作。

---

## 2. 技术栈架构

### 2.1 后端 (Server)
*   **语言**: Python 3.10+
*   **Web 框架**: **FastAPI** (高性能异步框架)
*   **ORM**: **SQLAlchemy** (AsyncIO 扩展，支持异步数据库操作)
*   **数据库**:
    *   **SQLite** (开发/测试环境默认，无需安装)
    *   **PostgreSQL** (生产环境推荐)
*   **向量数据库**: **ChromaDB** (本地嵌入式向量库，用于 RAG 检索)
*   **缓存/消息队列**: **Redis** (用于 API 缓存，具备内存降级机制)
*   **AI 编排**: **LangChain** (集成 OpenAI 接口与向量检索逻辑)
*   **依赖管理**: `requirements.txt`

### 2.2 前端 (Client)
*   **模式**: No-Build (CDN 引入，无需 Node.js 构建步骤，开箱即用)
*   **核心库**: **Vue 3** (Composition API)
*   **UI 组件库**: **Element Plus**
*   **样式库**: **TailwindCSS**
*   **Markdown 渲染**: **Marked.js** + **Highlight.js**

---

## 3. 系统分层架构

系统采用经典的**分层架构 (Layered Architecture)**，确保职责分离，提升可维护性。

```mermaid
graph TD
    Client[前端客户端 Vue3] <--> API[API 路由层 (Controller)]
    API <--> Service[业务逻辑层 (Service)]
    Service <--> Model[数据访问层 (ORM Models)]
    Service <--> VectorDB[(向量数据库 Chroma)]
    Service <--> LLM[大语言模型 API]
    Model <--> DB[(关系型数据库 SQLite/PG)]
    Service <--> Cache[(Redis 缓存)]
```

### 3.1 目录结构说明

```
Wiki/
├── backend/                # 后端根目录
│   ├── app/                # 应用代码主目录
│   │   ├── api/            # [API 层] 路由定义，处理 HTTP 请求/响应
│   │   │   ├── agent.py    # AI 助手相关接口
│   │   │   ├── documents.py# 文档管理接口
│   │   │   ├── folders.py  # 文件夹管理接口
│   │   │   ├── images.py   # 图片上传接口
│   │   │   └── api.py      # 路由汇总
│   │   ├── config.py       # 全局配置 (环境变量加载)
│   │   ├── database.py     # 数据库连接池与 Session 管理
│   │   ├── db_init.py      # 数据库初始化脚本
│   │   ├── models.py       # [Model 层] 数据库实体定义
│   │   ├── schemas.py      # [DTO 层] Pydantic 数据校验模式
│   │   ├── service.py      # [Service 层] 核心业务逻辑封装
│   │   ├── cache.py        # Redis 缓存管理器
│   │   ├── logger.py       # [Log 层] 统一日志配置与上下文管理
│   │   └── main.py         # 应用入口，生命周期与中间件配置
│   ├── chroma_db/          # 向量数据库持久化文件的存储目录
│   ├── static/             # 静态资源目录
│   │   ├── js/             # 前端 JS 逻辑
│   │   ├── css/            # 自定义样式
│   │   └── uploads/        # 用户上传的图片
│   ├── templates/          # 前端 HTML 模板
│   └── requirements.txt    # Python 依赖列表
├── 项目架构说明书.md        # 本文档
├── 项目详细设计报告.md      # 详细设计文档
├── 项目开发进度详单.md      # 开发进度追踪
└── 项目全景上下文备忘录.md  # 项目背景与愿景记录
```

---

## 4. 核心模块功能设计

### 4.1 业务逻辑层 (Service Layer)
所有业务逻辑集中在 `backend/app/service.py`，主要包含以下服务类：

1.  **BaseService**: 提供数据库 Session 的基础封装。
2.  **DocumentService**:
    *   管理文档的 CRUD。
    *   负责文档列表的 Redis 缓存读写与失效策略。
    *   调用 AgentService 进行文档索引。
3.  **FolderService**:
    *   管理文件夹的层级结构。
    *   提供递归或聚合查询，返回文件夹树形结构。
4.  **AgentService**:
    *   **RAG 引擎**: 实现 "检索-增强-生成" 闭环。
    *   **Index**: 使用 LangChain `RecursiveCharacterTextSplitter` 对文档进行切片并存入 ChromaDB。
    *   **Search**: 将用户问题向量化，检索最相似的 Top-K 文档片段。
    *   **Generate**: 将检索到的上下文拼接到 Prompt 中，请求 LLM 生成回答。
5.  **LogService**:
    *   异步记录操作日志到数据库。

### 4.2 数据流设计

#### 4.2.1 文档创建流程
1.  用户发起 `POST /api/v1/documents/` 请求。
2.  `DocumentService` 将文档元数据写入 SQLite。
3.  `DocumentService` 清除 Redis 中的文档列表缓存。
4.  `BackgroundTasks` 触发 `AgentService.index_document`，异步将文档内容向量化存入 ChromaDB。
5.  `BackgroundTasks` 触发 `LogService.log_operation`，异步记录 "创建文档" 日志。

#### 4.2.2 RAG 问答流程
1.  用户发起 `POST /api/v1/agent/chat` 请求。
2.  `AgentService.rag_qa` 接收问题。
3.  **检索**: 在 ChromaDB 中搜索与问题语义最接近的 3 个文档片段。
4.  **构建**: 提取片段内容作为 `Context`，组装 Prompt。
5.  **生成**: 调用 OpenAI API，传入 Prompt。
6.  **响应**: 返回 LLM 的回答以及引用的来源文档 (`sources`)。

---

## 5. 日志与监控设计

### 5.1 操作日志 (Business Log)
*   **存储**: 数据库表 `system_logs`。
*   **内容**: 记录谁 (User)、在什么时候 (Time)、对什么资源 (Resource)、做了什么 (Action)、结果如何 (Status)。
*   **用途**: 审计、用户行为分析。

### 5.2 系统日志 (System Log)
*   **存储**: 文件日志 `logs/user_ops.log`。
*   **机制**: 通过 FastAPI 中间件 `log_requests` 拦截。
*   **内容**: HTTP 方法、URL 路径、响应状态码、处理耗时 (Latency)。
*   **用途**: 性能监控、故障排查。
