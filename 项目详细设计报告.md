# 项目详细设计报告

## 1. 数据库设计 (Schema)

本项目使用 SQLAlchemy ORM 定义模型，支持 SQLite 和 PostgreSQL。以下是核心实体关系模型 (ER) 设计。

### 1.1 文件夹 (Folders)
用于组织文档，支持无限层级嵌套。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | Integer | PK, Auto Inc | 文件夹唯一标识 |
| `title` | String(255) | Not Null | 文件夹名称 |
| `parent_id` | Integer | FK -> folders.id | 父文件夹 ID (根目录为 NULL) |
| `is_active` | Boolean | Default True | 软删除标记 |
| `created_at` | DateTime | Default Now | 创建时间 |

### 1.2 文档 (Documents)
系统的核心数据实体。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | Integer | PK, Auto Inc | 文档唯一标识 |
| `title` | String(255) | Not Null | 文档标题 |
| `content` | Text | Nullable | 文档内容 (Markdown 格式) |
| `folder_id` | Integer | FK -> folders.id | 所属文件夹 ID |
| `summary` | Text | Nullable | AI 生成的文档摘要 |
| `tags` | String(255) | Nullable | 标签 (逗号分隔) |
| `version` | Integer | Default 1 | 版本号 (预留字段) |
| `is_active` | Boolean | Default True | 软删除标记 |

### 1.3 系统日志 (Logs)
记录全系统的操作审计轨迹。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | Integer | PK, Auto Inc | 日志 ID |
| `user_id` | String(50) | Nullable | 操作人标识 |
| `action` | String(100) | Not Null | 动作 (e.g., CREATE, DELETE) |
| `resource_type` | String(50) | Nullable | 资源类型 (DOCUMENT, FOLDER) |
| `resource_id` | String(50) | Nullable | 资源 ID |
| `details` | JSON | Nullable | 操作详情快照 |
| `timestamp` | DateTime | Default Now | 操作时间 |

---

## 2. API 接口定义

所有 API 前缀为 `/api/v1`。

### 2.1 文档接口 (`/documents`)
*   `POST /`
    *   **功能**: 创建文档
    *   **参数**: `{ title: str, content: str, folder_id: int }`
    *   **后台**: 触发向量索引、日志记录。
*   `GET /`
    *   **功能**: 获取文档列表
    *   **响应**: 文档摘要列表 (优先查 Redis)。
*   `GET /{id}`
    *   **功能**: 获取文档详情
    *   **响应**: 完整文档对象。

### 2.2 文件夹接口 (`/folders`)
*   `POST /`
    *   **功能**: 创建文件夹
    *   **参数**: `{ title: str, parent_id: int }`
*   `GET /`
    *   **功能**: 获取所有文件夹结构
*   `GET /{id}`
    *   **功能**: 获取指定文件夹详情及内容 (包含子文件夹和文档)

### 2.3 Agent 接口 (`/agent`)
*   `POST /chat`
    *   **功能**: AI 对话
    *   **参数**: `{ messages: [...], use_rag: bool }`
    *   **响应**: `{ response: str, sources: [...] }`
*   `POST /polish`
    *   **功能**: 文本润色
*   `POST /complete`
    *   **功能**: 文本续写

### 2.4 图片接口 (`/images`)
*   `POST /upload`
    *   **功能**: 上传图片
    *   **格式**: `multipart/form-data`
    *   **响应**: `{ url: str, filename: str }`

---

## 3. 前端逻辑设计

前端采用 **Vue 3** + **Element Plus** 构建，逻辑集中在 `backend/static/js/app.js`。

### 3.1 状态管理 (Reactive State)
使用 Vue 的 `ref` 和 `reactive` 管理全局状态：
*   `documents`: 文档列表数据。
*   `folders`: 文件夹树形数据。
*   `currentDoc`: 当前选中的文档对象 (用于编辑/查看)。
*   `chatMessages`: 聊天窗口的历史消息列表。
*   `isSaving`: 保存按钮的 Loading 状态。

### 3.2 核心交互逻辑
1.  **文档编辑与预览**:
    *   左侧为 `el-input` (type=textarea) 编辑 Markdown 源码。
    *   右侧使用 `marked.parse(content)` 实时渲染 HTML。
    *   监听输入事件，支持 `Ctrl+S` 快捷键保存。
2.  **AI 侧边栏**:
    *   独立的悬浮组件。
    *   用户发送消息 -> 添加到 `chatMessages` -> 调用后端 `/agent/chat` -> 接收流式或全量响应 -> 更新 UI。
    *   支持展示 RAG 检索到的 `sources` (来源文档标题)。
3.  **图片上传**:
    *   拦截粘贴事件 (Paste Event) 或点击工具栏按钮。
    *   调用 `/images/upload` 接口。
    *   成功后将 Markdown 图片语法 `![](/static/uploads/xxx.jpg)` 插入光标位置。

---

## 4. 异常处理与降级策略

### 4.1 缓存降级
*   **场景**: Redis 服务宕机或连接超时。
*   **策略**: `RedisManager` 捕获连接异常，自动切换到 `MemoryCache` (Python 字典)。
*   **恢复**: 系统不会自动重连 Redis (需重启)，但保证了服务不中断。

### 4.2 API 错误处理
*   **HTTPException**: 在 API 层捕获业务错误 (如 404 Not Found)。
*   **Global Exception Handler**: 捕获未处理异常，返回标准 500 错误格式，并记录堆栈日志。
