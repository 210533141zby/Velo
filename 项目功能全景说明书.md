# Wiki 项目功能全景说明书

> 本文档详细记录了 Wiki 项目（本地知识库 + AI 问答助手）的所有功能模块、API 接口、核心类及其职责。旨在为开发人员提供清晰的系统全景视图，特别是在功能迭代和代码维护时作为参考。

## 快速开始 (Quick Start)

**启动项目 (推荐):**
本项目提供了一个跨平台管理脚本，可一键启动 Redis (如果存在) 和后端服务。

```bash
# 1. 激活环境
conda activate Wiki

# 2. 运行管理脚本
python manage.py
```

> **提示**: `manage.py` 会自动处理数据库初始化和 Redis 启动。如果 Redis 不可用，系统会自动以内存缓存模式运行。

## 1. 项目概览

**Wiki AI** 是一个轻量级的、支持本地部署的智能知识库系统。它结合了传统的文档管理功能和现代的大模型（LLM）能力，实现了“私人知识库问答”的核心体验。

-   **核心技术**: FastAPI (后端), Vue3 (前端 No-Build), SQLite (关系数据), ChromaDB (向量数据), LangChain (AI 编排)。
-   **部署模式**: 纯本地部署，支持断网运行（需本地 LLM 配合）或混合模式（OpenAI API）。

---

## 2. 核心功能模块详情

### 2.1 文档管理模块 (Document Management)

负责知识库核心内容的增删改查。

*   **对应服务类**: `DocumentService` (`backend/app/service.py`)
*   **API 路由**: `/api/v1/documents` (`backend/app/api/documents.py`)

| 功能名称 | 接口路径 (HTTP) | 方法 | 详细描述 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **获取文档列表** | `/` | GET | 获取所有文档的摘要列表。优先从 Redis 缓存读取，未命中则查询 SQLite 并回写缓存（TTL 5分钟）。 | **性能优化**: 列表页响应极快 |
| **获取文档详情** | `/{doc_id}` | GET | 根据 ID 获取文档完整内容（Markdown 源码）。 | |
| **创建文档** | `/` | POST | 创建新文档。创建成功后，会触发后台任务将文档内容索引到 ChromaDB 向量库中，以支持 RAG 检索。 | **异步处理**: 索引不阻塞 API |
| **更新文档** | `/{doc_id}` | PUT | 更新文档标题或内容。同时更新数据库和向量库索引，并使缓存失效。 | **一致性**: 保证搜索结果最新 |
| **删除文档** | `/{doc_id}` | DELETE | 软删除文档（标记 `is_active=False`）。同时从向量库中移除索引。 | **安全**: 数据可恢复 |

### 2.2 文件夹管理模块 (Folder Management)

负责文档的层级组织。

*   **对应服务类**: `FolderService` (`backend/app/service.py`)
*   **API 路由**: `/api/v1/folders` (`backend/app/api/folders.py`)

| 功能名称 | 接口路径 (HTTP) | 方法 | 详细描述 |
| :--- | :--- | :--- | :--- |
| **创建文件夹** | `/` | POST | 创建新的文件夹容器。 |
| **获取文件夹详情** | `/{folder_id}` | GET | 获取指定文件夹下的所有文档列表。 |
| **删除文件夹** | `/{folder_id}` | DELETE | 删除文件夹。通常要求文件夹为空才能删除（具体逻辑视实现而定）。 |

### 2.3 AI 智能助手模块 (AI Agent)

负责与大模型交互，提供智能问答和辅助写作功能。

*   **对应服务类**: `AgentService` (`backend/app/service.py`)
*   **API 路由**: `/api/v1/agent` (`backend/app/api/agent.py`)

| 功能名称 | 接口路径 (HTTP) | 方法 | 详细描述 | 关键技术 |
| :--- | :--- | :--- | :--- | :--- |
| **RAG 问答 (Chat)** | `/chat` | POST | 用户提问 -> 系统在 ChromaDB 检索相关文档片段 -> 构建 Prompt -> LLM 生成回答。返回答案及引用来源。 | **LangChain**, **RAG** |
| **文本润色** | `/polish` | POST | 接收一段文本，调用 LLM 进行润色，使其更专业、简洁。 | Prompt Engineering |
| **内容续写** | `/complete` | POST | 根据给定的上文，让 AI 自动补全后续内容。 | Completion |

### 2.4 系统基础设施

#### 2.4.1 缓存服务 (Cache Service)
*   **类**: `CacheManager` (`backend/app/cache.py`)
*   **策略**: **智能降级 (Smart Fallback)**
    1.  优先尝试连接本地 Redis 服务器。
    2.  如果 Redis 连接失败（如未安装或服务未启动），自动无缝切换到**进程内内存缓存**。
    3.  保证在任何环境下（开发/生产/Windows/Linux）都能即刻运行，无需强制依赖。

#### 2.4.2 日志服务 (Log Service)
*   **类**: `LogService` (`backend/app/service.py`)
*   **功能**: 记录所有关键操作（文档创建、删除、更新）到 `logs` 表，包含操作人、时间、资源ID。

#### 2.4.3 前端架构 (Frontend)
*   **设计**: **No-Build (无构建)** 模式。
*   **核心**: 直接在 `index.html` 中通过 `<script>` 标签引入 Vue 3, Element Plus, TailwindCSS (CDN)。
*   **优势**: 极致简单，修改 `app.js` 即可生效，无需 Node.js 环境，无需 `npm run build`，非常适合个人本地项目。

---

## 3. 已移除/暂存功能

以下功能在代码优化过程中已被移除，但在此记录以备未来恢复。

### 3.1 图片上传 (Image Upload)
*   **原服务类**: `ImageService` (已删除)
*   **原路由**: `/api/v1/images/upload`
*   **功能逻辑**:
    1.  接收前端上传的图片文件 (`UploadFile`)。
    2.  生成唯一文件名：`YYYYMMDD_{UUID}.ext`。
    3.  保存到 `backend/static/uploads/` 目录。
    4.  返回相对 URL `/static/uploads/...` 供 Markdown 引用。
*   **恢复指南**:
    如果需要恢复，需重新创建 `api/images.py`，并在 `service.py` 中恢复 `ImageService` 类，然后在 `api/api.py` 中注册路由。

---

## 4. 数据库与存储架构

### 4.1 关系型数据库 (SQLite)
文件位置: `backend/wiki.db`
主要表结构:
-   `documents`: 存储文档元数据和 Markdown 内容。
-   `folders`: 存储文件夹层级。
-   `logs`: 存储系统操作审计日志。

### 4.2 向量数据库 (ChromaDB)
文件夹位置: `backend/chroma_db`
-   存储文档内容的 Embedding 向量，用于语义搜索。
-   即使删除了 SQLite 中的文档，建议同步清理 Chroma 中的记录以保持一致性。

### 4.3 静态文件存储
文件夹位置: `backend/static`
-   `js/`: 前端逻辑 (`app.js`)。
-   `css/`: 样式表。
-   `uploads/`: (预留) 用户上传的图片。
