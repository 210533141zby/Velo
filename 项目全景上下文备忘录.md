# 项目全景上下文备忘录

## 1. 文档目的
本文档旨在为 **AI 助手** 或 **新加入的开发者** 提供项目的**全景上下文**。假如对话历史丢失，或者需要重新接手该项目，阅读本文档应能获取继续开发所需的所有关键信息、设计理念及未尽事宜。

---

## 2. 项目愿景与核心价值 (Project Vision)
*   **做什么**: 一个支持私有化部署的 **AI 智能 Wiki 知识库**。
*   **解决什么问题**: 解决传统 Wiki 检索困难、知识碎片化的问题。通过 RAG 技术，让 Wiki 能够"理解"文档内容，用户可以直接通过自然语言提问获取答案，而无需手动翻阅文档。
*   **核心体验**: "写文档像记事本一样简单，查知识像问专家一样自然。"

---

## 3. 关键架构决策 (Architectural Decisions)

### 3.1 为什么选择 FastAPI + Vue (CDN)?
*   **FastAPI**: Python 生态中 RAG/LLM 支持最好的 Web 框架，异步性能高，适合 I/O 密集型的 AI 请求。
*   **Vue (CDN)**: 
    *   **决策**: 放弃复杂的 Node.js/Webpack/Vite 构建流程。
    *   **理由**: 项目定位于轻量级、易部署。后端直接托管静态文件，用户只需安装 Python 依赖即可运行，无需配置前端环境。这极大地降低了部署和二次开发的门槛。

### 3.2 为什么设计 Service 层?
*   初期代码将逻辑写在 API 路由中，导致代码臃肿且难以复用。
*   重构后引入 `Service` 层 (e.g., `DocumentService`, `AgentService`)，实现了业务逻辑与 HTTP 接口的解耦。这对于未来可能增加的 CLI 接口或 WebSocket 接口至关重要。

### 3.3 RAG 实现细节
*   **向量库**: 使用 ChromaDB 的持久化模式，数据存储在本地磁盘，无需额外部署向量数据库服务。
*   **索引时机**: 文档创建/更新时**同步**或**异步**触发索引更新。目前采用 `BackgroundTasks` 异步处理，避免阻塞 HTTP 响应。

---

## 4. 环境与运行指南 (Runbook)

### 4.1 启动项目
假如你刚接手代码，请按以下步骤启动：

1.  **环境准备**: 确保安装 Python 3.10+ 和 Redis (可选，无 Redis 会自动降级)。
2.  **依赖安装**:
    ```bash
    pip install -r backend/requirements.txt
    ```
3.  **配置**: 检查 `backend/app/config.py`，确保 `OPENAI_API_KEY` 环境变量已设置。
4.  **启动**:
    ```bash
    cd backend
    uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
    ```
5.  **访问**: 打开浏览器访问 `http://localhost:8000/`。

### 4.2 项目结构速查
*   后端逻辑都在 `backend/app/`。
*   前端逻辑都在 `backend/static/js/app.js`。
*   页面结构在 `backend/templates/index.html`。
*   数据库文件 (SQLite) 会生成在 `backend/wiki.db`。
*   向量库数据在 `backend/chroma_db/`。

---

## 5. 遗留问题与下一步计划 (Next Steps)

如果你是接手的 AI，请优先关注以下任务：

1.  **鉴权模块缺失**: 当前系统是裸奔的。**这是最高优先级任务**。需要实现一个基于 OAuth2 的 Token 验证机制。
2.  **RAG 准确率优化**: 目前只是简单的切片。需要引入更高级的 RAG 策略，比如父子文档索引 (Parent Document Retriever) 或假设性问题嵌入 (HyDE)。
3.  **前端交互优化**: 当前前端代码是一个巨大的 `app.js` 文件。虽然为了免构建这是妥协，但随着功能增加，考虑将其拆分为多个 ES Module (通过 `<script type="module">` 引入) 会更好。
4.  **知识图谱**: 代码里有一个 `generate_knowledge_graph` 的桩代码。下一步应该引入图形可视化库 (如 ECharts Graph)，将提取出的实体关系展示在前端。

---

## 6. 关键数据结构快照

**ChatRequest Schema**:
```json
{
  "messages": [{"role": "user", "content": "..."}],
  "use_rag": true,
  "doc_id": null
}
```

**Document Model**:
*   `content`: Markdown 源码
*   `summary`: AI 自动生成的摘要
*   `folder_id`: 关联文件夹

**Log Structure**:
*   `action`: 操作动词 (CREATE, DELETE, QUERY)
*   `details`: 任意 JSON 对象，记录上下文
