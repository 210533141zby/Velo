# 后端启动路径模块缺失故障报告

## 问题: manage.py 启动失败 (ModuleNotFoundError: No module named 'app')
**日期:** 2026-01-09
**状态:** 已解决
**严重程度:** 阻断性 (Critical) - 服务无法启动

### 1. 问题描述
在运行 `python manage.py` 尝试启动后端服务时，控制台抛出以下异常，导致进程直接退出：
```
Traceback (most recent call last):
  File "D:\Working\seek\Wiki\backend\app\main.py", line 14, in <module>
    from app.config import settings
ModuleNotFoundError: No module named 'app'
```

### 2. 根本原因分析 (Root Cause Analysis)

#### 2.1 Python 模块搜索路径 (PYTHONPATH) 机制
*   **项目结构**:
    ```
    Wiki/
    ├── manage.py
    └── backend/
        └── app/
            ├── main.py
            └── config.py
    ```
*   **执行上下文**: 当用户在 `Wiki/` 根目录下运行 `manage.py` 时，Python 默认将当前目录 (`d:\Working\seek\Wiki`) 加入 `sys.path`。
*   **导入错误**: 代码中使用 `from app.config import settings`。这要求 `app` 包必须直接位于 `sys.path` 的某个目录下。
*   **实际情况**: `app` 位于 `backend/` 目录下。Python 能找到 `backend`，但无法直接在根目录下找到 `app`。因此，`import backend.app` 是合法的，但直接 `import app` 会失败。

#### 2.2 Uvicorn 启动命令配置不当
原有的启动命令为：
```python
uvicorn backend.app.main:app --reload
```
这虽然指明了文件路径，但内部代码 (`main.py`) 依然尝试以 `app` 为顶级包进行绝对导入，这与运行时的路径环境不一致。

### 3. 解决方案实施

#### 3.1 动态注入环境变量
在 `manage.py` 中，在启动子进程前，动态修改环境变量 `PYTHONPATH`，将 `backend` 目录显式加入：

```python
# 获取 backend 绝对路径
backend_path = BASE_DIR / "backend"

# 注入到环境变量
env = os.environ.copy()
if "PYTHONPATH" in env:
    env["PYTHONPATH"] = f"{str(backend_path)}{os.pathsep}{env['PYTHONPATH']}"
else:
    env["PYTHONPATH"] = str(backend_path)
```

#### 3.2 修正启动模块与命令
调整 Uvicorn 的调用方式，确保它在正确的路径上下文中运行：
```python
# 使用 sys.executable 确保环境一致性
# 使用 "app.main:app" 而非 "backend.app.main:app"
# 因为 backend 已经在 PYTHONPATH 中了，app 被视为顶级包
cmd = [sys.executable, "-m", "uvicorn", "app.main:app", "--reload", ...]
subprocess.run(cmd, env=env, ...)
```

#### 3.3 补充 `__init__.py`
在 `backend/app/` 目录下创建 `__init__.py` 文件，确保 Python 将其识别为标准的 Package，避免隐式命名空间包带来的潜在兼容性问题。

### 4. 验证结果
执行 `python manage.py` 后：
1.  `PYTHONPATH` 正确包含了 `backend` 目录。
2.  `main.py` 中的 `from app.config import ...` 能够成功解析。
3.  Uvicorn 服务成功绑定 `127.0.0.1:8000` 并启动。

### 5. 经验教训 (Lessons Learned)
1.  **路径敏感性**: Python 的导入机制高度依赖 `sys.path`。在跨目录调用或构建管理脚本时，必须明确控制 `PYTHONPATH`，不能假设默认路径能满足深层嵌套的包结构。
2.  **启动脚本健壮性**: `manage.py` 这类入口脚本应该具备环境自检和修复能力（如自动修正路径），而不是依赖用户手动设置环境变量。
