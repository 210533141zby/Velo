# 文档删除失败故障报告

## 问题: 删除文档操作失败
**日期:** 2026-01-09
**状态:** 已解决
**优先级:** 高

### 问题描述
用户在前端尝试删除文档时，界面提示“删除文档失败”。后端日志（如有）或调试显示 API 返回 500 Internal Server Error。

### 根本原因分析 (Root Cause Analysis)
1.  **代码逻辑缺陷**: 在 `DocumentService.delete_document` 方法中，代码试图调用 `AgentService` 的 `delete_document_index` 方法来清理向量数据库中的索引。
    ```python
    agent_service = AgentService(self.db)
    background_tasks.add_task(agent_service.delete_document_index, doc_id)
    ```
2.  **方法缺失**: 检查 `AgentService` 类定义 (`backend/app/service.py`)，发现该类中**不存在** `delete_document_index` 方法。
3.  **异常传播**: 当 Python 解释器在 `add_task` 参数求值时（访问方法属性），抛出了 `AttributeError`。由于未在 Service 层捕获该特定异常，导致 API 请求失败。

### 解决方案实施
在 `AgentService` 类中实现了缺失的 `delete_document_index` 方法，使用 Chroma 向量库的 `delete` 功能按 `doc_id` 元数据删除索引。

#### 代码变更 (`backend/app/service.py`)
```python
async def delete_document_index(self, doc_id: int):
    """
    从向量库中删除文档索引
    """
    try:
        # Chroma delete supports where filter
        # We need to run this in threadpool because Chroma client might be sync
        await run_in_threadpool(self.vector_store.delete, where={"doc_id": doc_id})
        
        logger.info(f"已删除文档索引: {doc_id}", extra={...})
    except Exception as e:
        logger.error(f"删除文档索引失败: {e}", exc_info=True, extra={...})
```

### 验证步骤
1.  启动后端服务。
2.  在前端创建一个测试文档。
3.  点击删除按钮。
4.  确认文档从列表消失，且提示“文档已删除”。
5.  检查日志确认 `rag_delete_success` 事件被记录。

### 经验教训
1.  **接口一致性**: 在调用服务方法前，必须确保该方法已定义并实现。
2.  **软删除与硬清理**: 业务数据的软删除（`is_active=False`）通常需要配合辅助数据（如向量索引）的硬清理或标记，以保持数据一致性。
